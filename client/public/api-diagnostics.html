<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual English - API Diagnostics</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
      background-color: #f9f9f9;
    }
    h1 { 
      color: #0066cc; 
      text-align: center;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    h2 {
      color: #444;
      margin-top: 30px;
      border-left: 4px solid #0066cc;
      padding-left: 10px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      background-color: white;
    }
    .success { 
      color: green; 
      font-weight: 600;
    }
    .error { 
      color: red; 
      font-weight: 600;
    }
    .pending {
      color: #f59e0b;
      font-weight: 600;
    }
    .info {
      color: #3b82f6;
      font-weight: 600;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    button:hover { 
      background: #0055aa; 
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      border: 1px solid #eee;
    }
    .api-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
    }
    .diagnostic-row {
      background-color: #f5f8ff;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      border: 1px solid #e0e7ff;
    }
    .diagnostic-label {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .summary {
      margin-top: 20px;
      padding: 15px;
      background-color: #f0f9ff;
      border-radius: 8px;
      border: 1px solid #bae6fd;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .stat-box {
      background: white;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin: 5px 0;
    }
    .action-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab-bar {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 15px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      margin-right: 5px;
      border-radius: 4px 4px 0 0;
    }
    .tab.active {
      background-color: white;
      border-color: #ddd;
      border-bottom: 1px solid white;
      margin-bottom: -1px;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <h1>Visual English API Diagnostics</h1>
  <p>This page helps diagnose API connectivity issues and server integration problems. It performs various tests to identify where connections might be failing.</p>
  
  <div class="action-bar">
    <button id="runAllTests">Run All Tests</button>
    <button id="clearResults">Clear Results</button>
    <button id="navigateHome">Go to Home Page</button>
  </div>
  
  <div class="tab-bar">
    <div class="tab active" data-tab="api-tests">API Tests</div>
    <div class="tab" data-tab="network-info">Network Info</div>
    <div class="tab" data-tab="browser-info">Browser Info</div>
  </div>
  
  <div id="api-tests" class="tab-content active">
    <div class="card">
      <h2>Standard API Endpoints</h2>
      <p>Tests connectivity to API endpoints through the normal /api prefix.</p>
      <div class="api-grid">
        <button id="testHealthcheck" class="test-button">Test /api/healthcheck</button>
        <button id="testApi" class="test-button">Test /api/test</button>
      </div>
      <div id="standardResult" class="diagnostic-row" style="display: none;"></div>
    </div>
    
    <div class="card">
      <h2>Direct Endpoints</h2>
      <p>Tests connectivity to direct endpoints that bypass standard routing.</p>
      <div class="api-grid">
        <button id="testDirectHealthcheck" class="test-button">Test /healthcheck</button>
        <button id="testDirectApi" class="test-button">Test /testapi</button>
        <button id="testCors" class="test-button">Test CORS Support</button>
      </div>
      <div id="directResult" class="diagnostic-row" style="display: none;"></div>
    </div>
    
    <div class="card">
      <h2>Static File Tests</h2>
      <p>Tests browser's ability to load static assets.</p>
      <div class="api-grid">
        <button id="testStatic" class="test-button">Test Static Loading</button>
        <button id="testStaticImage" class="test-button">Test Image Loading</button>
      </div>
      <div id="staticResult" class="diagnostic-row" style="display: none;"></div>
    </div>
    
    <div class="card">
      <h2>Advanced Tests</h2>
      <p>More sophisticated connectivity tests.</p>
      <div class="api-grid">
        <button id="testTiming" class="test-button">Test Response Timing</button>
        <button id="testHeaders" class="test-button">Test Request Headers</button>
      </div>
      <div id="advancedResult" class="diagnostic-row" style="display: none;"></div>
    </div>
  </div>
  
  <div id="network-info" class="tab-content">
    <div class="card">
      <h2>Network Information</h2>
      <div id="networkInfo">
        <div class="diagnostic-row">
          <p class="diagnostic-label">URL Information:</p>
          <div id="urlInfo"></div>
        </div>
        <div class="diagnostic-row">
          <p class="diagnostic-label">Connection Information:</p>
          <div id="connectionInfo"></div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="browser-info" class="tab-content">
    <div class="card">
      <h2>Browser Information</h2>
      <div id="browserInfo">
        <div class="diagnostic-row">
          <p class="diagnostic-label">User Agent:</p>
          <div id="userAgent"></div>
        </div>
        <div class="diagnostic-row">
          <p class="diagnostic-label">Browser Features:</p>
          <div id="browserFeatures"></div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="card summary" id="summary" style="display: none;">
    <h2>Diagnostic Summary</h2>
    <p id="summaryText">Run tests to generate a summary</p>
    
    <div class="stats-grid">
      <div class="stat-box">
        <div>Tests Run</div>
        <div class="stat-value" id="testsRun">0</div>
      </div>
      <div class="stat-box">
        <div>Successes</div>
        <div class="stat-value success" id="testSuccesses">0</div>
      </div>
      <div class="stat-box">
        <div>Failures</div>
        <div class="stat-value error" id="testFailures">0</div>
      </div>
      <div class="stat-box">
        <div>Avg. Response</div>
        <div class="stat-value info" id="avgResponse">0ms</div>
      </div>
    </div>
  </div>
  
  <script>
    // Test results tracking
    const testResults = {
      total: 0,
      success: 0,
      failure: 0,
      responseTimes: []
    };
    
    // Tab switching functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const tabId = tab.dataset.tab;
        document.getElementById(tabId).classList.add('active');
      });
    });
    
    // Helper function for API requests with timing
    async function fetchWithTiming(url, options = {}) {
      const startTime = performance.now();
      try {
        const response = await fetch(url, options);
        const endTime = performance.now();
        const responseTime = endTime - startTime;
        
        testResults.responseTimes.push(responseTime);
        
        let data;
        const contentType = response.headers.get("content-type") || "";
        if (contentType.includes("application/json")) {
          data = await response.json();
        } else {
          data = await response.text();
        }
        
        return {
          success: response.ok,
          status: response.status,
          data,
          responseTime,
          headers: Object.fromEntries([...response.headers.entries()])
        };
      } catch (error) {
        const endTime = performance.now();
        const responseTime = endTime - startTime;
        
        testResults.responseTimes.push(responseTime);
        
        return {
          success: false,
          error: error.message,
          responseTime
        };
      }
    }
    
    // Function to update the result display
    function updateResult(elementId, result) {
      const resultElement = document.getElementById(elementId);
      resultElement.style.display = "block";
      
      // Update test stats
      testResults.total++;
      if (result.success) {
        testResults.success++;
      } else {
        testResults.failure++;
      }
      
      // Format the result for display
      let html = '';
      
      if (result.success) {
        html += `<p class="success">✓ Success (${Math.round(result.responseTime)}ms)</p>`;
      } else {
        html += `<p class="error">✗ Error: ${result.error || `HTTP ${result.status}`} (${Math.round(result.responseTime)}ms)</p>`;
      }
      
      // Show data if available
      if (result.data) {
        if (typeof result.data === 'object') {
          html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
        } else {
          html += `<pre>${result.data}</pre>`;
        }
      }
      
      // Show headers if available
      if (result.headers) {
        html += `<p class="info">Response Headers:</p>`;
        html += `<pre>${JSON.stringify(result.headers, null, 2)}</pre>`;
      }
      
      resultElement.innerHTML = html;
      
      // Update summary
      updateSummary();
    }
    
    // Update the summary statistics
    function updateSummary() {
      const summary = document.getElementById('summary');
      summary.style.display = "block";
      
      document.getElementById('testsRun').textContent = testResults.total;
      document.getElementById('testSuccesses').textContent = testResults.success;
      document.getElementById('testFailures').textContent = testResults.failure;
      
      // Calculate average response time
      const avgTime = testResults.responseTimes.length 
        ? Math.round(testResults.responseTimes.reduce((sum, time) => sum + time, 0) / testResults.responseTimes.length) 
        : 0;
      document.getElementById('avgResponse').textContent = `${avgTime}ms`;
      
      // Generate summary text
      let summaryText = "Based on the test results: ";
      
      if (testResults.failure === 0) {
        summaryText += "All API connections are working correctly.";
      } else if (testResults.failure < testResults.total / 2) {
        summaryText += "Some API connections are failing. Check the results for details.";
      } else {
        summaryText += "Most or all API connections are failing. There appears to be a significant connectivity issue.";
      }
      
      document.getElementById('summaryText').textContent = summaryText;
    }
    
    // Standard API Endpoints Testing
    document.getElementById('testHealthcheck').addEventListener('click', async () => {
      const result = await fetchWithTiming('/api/healthcheck');
      updateResult('standardResult', result);
    });
    
    document.getElementById('testApi').addEventListener('click', async () => {
      const result = await fetchWithTiming('/api/test');
      updateResult('standardResult', result);
    });
    
    // Direct Endpoints Testing
    document.getElementById('testDirectHealthcheck').addEventListener('click', async () => {
      const result = await fetchWithTiming('/healthcheck');
      updateResult('directResult', result);
    });
    
    document.getElementById('testDirectApi').addEventListener('click', async () => {
      const result = await fetchWithTiming('/testapi');
      updateResult('directResult', result);
    });
    
    document.getElementById('testCors').addEventListener('click', async () => {
      const result = await fetchWithTiming('/cors-test');
      updateResult('directResult', result);
    });
    
    // Static Content Testing
    document.getElementById('testStatic').addEventListener('click', async () => {
      // Test if a static HTML file loads correctly
      const result = await fetchWithTiming('/static-test.html');
      updateResult('staticResult', result);
    });
    
    document.getElementById('testStaticImage').addEventListener('click', async () => {
      const startTime = performance.now();
      
      // Test image loading
      const img = new Image();
      const testResult = {
        success: false,
        responseTime: 0
      };
      
      // Create a promise that resolves when the image loads or errors
      const imagePromise = new Promise((resolve) => {
        img.onload = () => {
          const endTime = performance.now();
          testResult.success = true;
          testResult.responseTime = endTime - startTime;
          testResult.data = `Image loaded successfully: ${img.width}x${img.height}px`;
          resolve(testResult);
        };
        
        img.onerror = () => {
          const endTime = performance.now();
          testResult.success = false;
          testResult.error = "Failed to load test image";
          testResult.responseTime = endTime - startTime;
          resolve(testResult);
        };
      });
      
      // Set source to test image - using favicon as it should be available 
      img.src = '/favicon.ico';
      
      // Wait for the image to load or error
      const result = await imagePromise;
      updateResult('staticResult', result);
    });
    
    // Advanced Testing
    document.getElementById('testTiming').addEventListener('click', async () => {
      // Test multiple requests to measure timing consistency
      const results = [];
      const iterations = 3;
      
      for (let i = 0; i < iterations; i++) {
        results.push(await fetchWithTiming('/api/healthcheck'));
      }
      
      // Calculate timing stats
      const times = results.map(r => r.responseTime);
      const avgTime = times.reduce((sum, time) => sum + time, 0) / times.length;
      const minTime = Math.min(...times);
      const maxTime = Math.max(...times);
      const variance = Math.max(...times) - Math.min(...times);
      
      // Format the result
      const testResult = {
        success: results.every(r => r.success),
        responseTime: avgTime,
        data: {
          averageResponseTime: Math.round(avgTime) + 'ms',
          minResponseTime: Math.round(minTime) + 'ms',
          maxResponseTime: Math.round(maxTime) + 'ms',
          variance: Math.round(variance) + 'ms',
          iterations,
          successRate: `${results.filter(r => r.success).length}/${iterations}`
        }
      };
      
      updateResult('advancedResult', testResult);
    });
    
    document.getElementById('testHeaders').addEventListener('click', async () => {
      // Test request & response headers
      const headers = new Headers();
      headers.append('X-Test-Header', 'test-value');
      headers.append('X-Custom-Diagnostic', 'visual-english-diagtool');
      
      const result = await fetchWithTiming('/api/test', {
        headers,
        method: 'GET'
      });
      
      updateResult('advancedResult', result);
    });
    
    // Run all tests
    document.getElementById('runAllTests').addEventListener('click', async () => {
      const testButtons = document.querySelectorAll('.test-button');
      let activeButton = null;
      
      // Reset results
      testResults.total = 0;
      testResults.success = 0;
      testResults.failure = 0;
      testResults.responseTimes = [];
      
      // Disable all buttons during testing
      testButtons.forEach(button => {
        button.disabled = true;
      });
      
      // Run each test with a small delay between them
      for (const button of testButtons) {
        activeButton = button;
        button.click();
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      // Re-enable buttons
      testButtons.forEach(button => {
        button.disabled = false;
      });
    });
    
    // Clear results
    document.getElementById('clearResults').addEventListener('click', () => {
      document.querySelectorAll('.diagnostic-row').forEach(el => {
        el.style.display = 'none';
        el.innerHTML = '';
      });
      
      document.getElementById('summary').style.display = 'none';
      
      // Reset test results
      testResults.total = 0;
      testResults.success = 0;
      testResults.failure = 0;
      testResults.responseTimes = [];
    });
    
    // Navigate home
    document.getElementById('navigateHome').addEventListener('click', () => {
      window.location.href = '/';
    });
    
    // Initialize network info
    function initNetworkInfo() {
      const urlInfo = document.getElementById('urlInfo');
      
      // URL information
      urlInfo.innerHTML = `
        <p>Protocol: ${window.location.protocol}</p>
        <p>Hostname: ${window.location.hostname}</p>
        <p>Port: ${window.location.port || "(default)"}</p>
        <p>Path: ${window.location.pathname}</p>
        <p>Full URL: ${window.location.href}</p>
      `;
      
      // Connection information
      const connectionInfo = document.getElementById('connectionInfo');
      
      if ('connection' in navigator) {
        const conn = navigator.connection;
        connectionInfo.innerHTML = `
          <p>Online: ${navigator.onLine ? "Yes" : "No"}</p>
          <p>Effective Type: ${conn.effectiveType || "unknown"}</p>
          <p>Downlink: ${conn.downlink || "unknown"} Mbps</p>
          <p>Round-Trip Time: ${conn.rtt || "unknown"} ms</p>
          <p>Save Data Mode: ${conn.saveData ? "Yes" : "No"}</p>
        `;
      } else {
        connectionInfo.innerHTML = `
          <p>Online: ${navigator.onLine ? "Yes" : "No"}</p>
          <p>Network Information API not available in this browser</p>
        `;
      }
    }
    
    // Initialize browser info
    function initBrowserInfo() {
      const userAgentElement = document.getElementById('userAgent');
      userAgentElement.innerHTML = `<p>${navigator.userAgent}</p>`;
      
      const browserFeatures = document.getElementById('browserFeatures');
      const features = [
        { name: "Fetch API", supported: 'fetch' in window },
        { name: "Promise API", supported: 'Promise' in window },
        { name: "WebSockets", supported: 'WebSocket' in window },
        { name: "Service Workers", supported: 'serviceWorker' in navigator },
        { name: "Cookies Enabled", supported: navigator.cookieEnabled },
        { name: "IndexedDB", supported: 'indexedDB' in window },
        { name: "LocalStorage", supported: 'localStorage' in window },
        { name: "WebRTC", supported: 'RTCPeerConnection' in window }
      ];
      
      browserFeatures.innerHTML = features.map(feature => 
        `<p>${feature.name}: <span class="${feature.supported ? 'success' : 'error'}">${feature.supported ? "Supported" : "Not Supported"}</span></p>`
      ).join('');
    }
    
    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initNetworkInfo();
      initBrowserInfo();
    });
  </script>
</body>
</html>