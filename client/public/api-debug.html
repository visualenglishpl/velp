<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minimal API Debug Tool</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      background-color: #f8f9fa;
    }
    h1 { color: #0066cc; }
    h2 { color: #0077dd; margin-top: 2rem; }
    .card {
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 16px;
      margin-bottom: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #0055bb; }
    button.secondary { background: #6c757d; }
    button.secondary:hover { background: #5a6268; }
    input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    pre {
      background: #f5f5f5;
      padding: 16px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .header { margin-bottom: 8px; font-weight: bold; }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .log { color: #6c757d; font-family: monospace; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Minimal API Debug Tool</h1>
  <p>A lightweight diagnostic tool to test API connectivity without any frameworks.</p>
  
  <div class="card">
    <h2>Quick Tests</h2>
    <div class="grid">
      <button onclick="testHealthcheck()">Test Healthcheck API</button>
      <button onclick="testDirectAPI()">Test Direct API</button>
      <button onclick="testEcho()">Test Echo API</button>
      <button onclick="testCORS()" class="secondary">Test CORS</button>
      <button onclick="testError()" class="secondary">Test Error (404)</button>
      <button onclick="testDelay()" class="secondary">Test Delay (1s)</button>
    </div>
  </div>

  <div class="card">
    <h2>Custom API Request</h2>
    <div>
      <div class="header">URL:</div>
      <input type="text" id="apiUrl" value="/api/healthcheck" />
      
      <div class="header">Method:</div>
      <select id="apiMethod">
        <option value="GET">GET</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="DELETE">DELETE</option>
      </select>
      
      <div class="header">Request Body (for POST/PUT):</div>
      <textarea id="apiBody" rows="4" style="width: 100%"></textarea>

      <button onclick="sendCustomRequest()" style="margin-top: 8px">Send Request</button>
    </div>
  </div>

  <div class="card">
    <h2>Results</h2>
    <div>
      <div class="header">Status:</div>
      <div id="status">No requests sent yet.</div>
      
      <div class="header">Response Headers:</div>
      <pre id="headers"></pre>
      
      <div class="header">Response Data:</div>
      <pre id="result"></pre>
      
      <div class="header">Debug Log:</div>
      <pre id="log" class="log"></pre>
    </div>
  </div>

  <script>
    // Helper function to log messages
    function log(message, type = 'info') {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toISOString();
      const entry = `[${timestamp}] ${message}`;
      logElement.innerHTML = entry + '\n' + logElement.innerHTML;
      console.log(entry);
    }

    // Update status
    function updateStatus(message, isSuccess = true) {
      const statusElement = document.getElementById('status');
      statusElement.textContent = message;
      statusElement.className = isSuccess ? 'success' : 'error';
    }

    // Display response headers
    function displayHeaders(headers) {
      const headersElement = document.getElementById('headers');
      let headersText = '';
      
      for (const [key, value] of headers.entries()) {
        headersText += `${key}: ${value}\n`;
      }
      
      headersElement.textContent = headersText || 'No headers received';
    }

    // Display response data
    function displayResult(data) {
      const resultElement = document.getElementById('result');
      try {
        if (typeof data === 'object') {
          resultElement.textContent = JSON.stringify(data, null, 2);
        } else {
          resultElement.textContent = data || 'No data received';
        }
      } catch (err) {
        resultElement.textContent = `Error displaying result: ${err.message}`;
      }
    }

    // Basic error handler
    function handleError(error) {
      updateStatus(`Error: ${error.message}`, false);
      log(`Error: ${error.message}`, 'error');
    }

    // Generic function to make API requests
    async function makeRequest(url, method = 'GET', body = null) {
      try {
        log(`${method} request to ${url}`);
        updateStatus('Sending request...', true);
        
        const options = {
          method,
          headers: {
            'Accept': 'application/json',
            'X-Debug-Client': 'MinimalAPIDebugTool'
          },
          credentials: 'include'
        };
        
        if (body && (method === 'POST' || method === 'PUT')) {
          options.headers['Content-Type'] = 'application/json';
          options.body = typeof body === 'string' ? body : JSON.stringify(body);
        }
        
        const response = await fetch(url, options);
        log(`Received ${response.status} ${response.statusText} from ${url}`);
        
        displayHeaders(response.headers);
        
        // Try to parse as JSON first
        try {
          const data = await response.json();
          displayResult(data);
          updateStatus(`Request complete: ${response.status} ${response.statusText}`, response.ok);
          return data;
        } catch (jsonError) {
          // If not JSON, get as text
          const text = await response.text();
          displayResult(text);
          updateStatus(`Request complete: ${response.status} ${response.statusText}`, response.ok);
          return text;
        }
      } catch (error) {
        handleError(error);
        throw error;
      }
    }

    // Test Functions
    async function testHealthcheck() {
      try {
        await makeRequest('/api/healthcheck');
      } catch (error) {
        // Already handled by makeRequest
        log('Trying alternative URL for healthcheck...', 'info');
        try {
          await makeRequest('/healthcheck');
        } catch (altError) {
          log('All healthcheck attempts failed', 'error');
        }
      }
    }

    async function testDirectAPI() {
      try {
        await makeRequest('/testapi');
      } catch (error) {
        // Already handled by makeRequest
      }
    }

    async function testEcho() {
      try {
        await makeRequest('/echo?param1=value1&param2=value2');
      } catch (error) {
        // Already handled by makeRequest
      }
    }

    async function testCORS() {
      try {
        await makeRequest('/cors-test');
      } catch (error) {
        // Already handled by makeRequest
      }
    }

    async function testError() {
      try {
        await makeRequest('/test-error/404');
      } catch (error) {
        // Already handled by makeRequest
      }
    }

    async function testDelay() {
      try {
        updateStatus('Request sent, waiting for delayed response...', true);
        await makeRequest('/test-delay/1000');
      } catch (error) {
        // Already handled by makeRequest
      }
    }

    // Handle custom request
    async function sendCustomRequest() {
      const url = document.getElementById('apiUrl').value;
      const method = document.getElementById('apiMethod').value;
      const bodyElement = document.getElementById('apiBody');
      let body = null;
      
      if (bodyElement.value && (method === 'POST' || method === 'PUT')) {
        try {
          // Try to parse as JSON
          body = JSON.parse(bodyElement.value);
        } catch (e) {
          // If not valid JSON, use as string
          body = bodyElement.value;
        }
      }
      
      try {
        await makeRequest(url, method, body);
      } catch (error) {
        // Already handled by makeRequest
      }
    }

    // Check browser capabilities
    function checkCapabilities() {
      const capabilities = {
        fetch: typeof fetch !== 'undefined',
        json: typeof JSON !== 'undefined',
        promises: typeof Promise !== 'undefined',
        localStorage: typeof localStorage !== 'undefined',
        sessionStorage: typeof sessionStorage !== 'undefined'
      };
      
      log(`Browser capabilities check: ${JSON.stringify(capabilities)}`);
      
      if (!capabilities.fetch) {
        updateStatus('Warning: Your browser does not support Fetch API. This tool may not work correctly.', false);
      }
    }

    // Run when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      checkCapabilities();
      log('API Debug Tool loaded. Ready to test API endpoints.');
    });
  </script>
</body>
</html>